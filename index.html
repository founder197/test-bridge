<script>
  const nativeTokens = {
    1: "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE",
    137: "0x0000000000000000000000000000000000001010",
    56: "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE",
    42161: "0xEeeeeEeeeEeEeeEeEeEeeEEEeeeeEeeeeeeeEEeE"
  };

  let provider, signer, userAddress, currentQuote;

  const output = document.getElementById("output");
  const btnGetQuote = document.getElementById("getQuote");
  const btnExec = document.getElementById("executeBridge");

  const log = (msg) => (output.textContent = msg);

  document.getElementById("connectWallet").addEventListener("click", async () => {
    if (!window.ethereum) return alert("No injected wallet found!");
    provider = new ethers.providers.Web3Provider(window.ethereum, "any");
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    const network = await provider.getNetwork();
    document.getElementById("walletInfo").textContent =
      `Connected: ${userAddress.slice(0,6)}... (${network.name})`;
    document.getElementById("connectWallet").textContent = "‚úÖ Wallet Connected";
  });

  btnGetQuote.addEventListener("click", async () => {
    const fromChain = document.getElementById("fromChain").value;
    const toChain = document.getElementById("toChain").value;
    const amountEth = document.getElementById("amount").value;
    if (!amountEth) return alert("Enter amount");
    if (!userAddress) return alert("Connect wallet first");

    const fromToken = nativeTokens[fromChain];
    const toToken = nativeTokens[toChain];
    const fromAmount = (Number(amountEth) * 1e18).toString();

    const url = `/api/quote?fromChain=${fromChain}&toChain=${toChain}&fromToken=${fromToken}&toToken=${toToken}&fromAddress=${userAddress}&toAddress=${userAddress}&fromAmount=${fromAmount}`;

    log("üîç Fetching quote...");
    btnGetQuote.disabled = true;
    const res = await fetch(url);
    const data = await res.json();
    btnGetQuote.disabled = false;

    if (!data?.estimate) {
      log("‚ùå No route found.");
      btnExec.disabled = true;
      return;
    }

    currentQuote = data;
    const est = data.estimate;
    const result = {
      bridge: est.tool,
      fromAmount: amountEth,
      toAmount: (est.toAmount / 1e18).toFixed(6),
      fromChain,
      toChain,
      duration: est.executionDuration + " sec",
    };

    log(`‚úÖ Route found!\n\nBridge: ${result.bridge}\nFrom ‚Üí To: ${result.fromChain} ‚Üí ${result.toChain}\nAmount: ${result.fromAmount} ‚Üí ${result.toAmount}\nEstimated time: ${result.duration}`);

    btnExec.disabled = false;
    btnExec.textContent = `üöÄ Execute via ${result.bridge}`;
  });

  btnExec.addEventListener("click", async () => {
    if (!currentQuote) return alert("No quote yet!");
    btnExec.disabled = true;
    log("‚öôÔ∏è Preparing transaction...");

    const res = await fetch("/api/transaction", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(currentQuote)
    });
    const txData = await res.json();

    if (!txData.transactionRequest) {
      log("‚ùå No transaction data.");
      btnExec.disabled = false;
      return;
    }

    const tx = txData.transactionRequest;
    const txResponse = await signer.sendTransaction({
      to: tx.to,
      data: tx.data,
      value: tx.value ? ethers.BigNumber.from(tx.value) : 0
    });

    log(`üì§ Transaction sent!\nHash: ${txResponse.hash}\n‚è≥ Waiting confirmation...`);
    await txResponse.wait();

    log(`‚úÖ Bridge completed!\nHash: ${txResponse.hash}`);
    btnExec.textContent = "‚úÖ Bridge Done";
  });
</script>
